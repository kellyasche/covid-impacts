---
title: "Economic"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(extrafont)
library(readxl)
library(janitor)
library(lubridate)

loadfonts()
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         edr = ifelse(Name == "Minnesota", "Minnesota", edr) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r master job vacancies, include=FALSE, cache=TRUE}
master.jv.pr <- read_csv("Data/Job vacancies/Master-job-vacancies-pr.csv") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast")) %>%
  mutate(vacanrate = vacanrate / 100,
         data_id = seq(n()))

master.jv.2021.2q.pr <- read_csv("Data/Job vacancies/job-vacancies-2021-2q-pr.csv") %>%
  rename(planning.region = 1) %>%
  filter(soclevel == 0) %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         vacanrate = vacanrate / 100) %>%
  select(1:23) %>%
  mutate(data_id = seq(n()))

```

```{r master laborforce, include=FALSE, cache=TRUE}
master.lf.pr <- read_csv("Data/Workforce/Master-annual-labor-force-pr.csv") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.lf.edr <- read_csv("Data/Workforce/Master-annual-labor-force-edr.csv") %>%
  mutate(EDR = fct_relevel(EDR, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  left_join(regions, by = c("EDR" = "edr"))

```

```{r master employment, include=FALSE, cache=TRUE}

master.emp.gender.county <- read_csv("Data/Workforce/Gender/Master-lf-gender-pr.csv") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         sex = ifelse(sex == 1, "Male", "Female")) 
```

```{r master qcew, include=FALSE, cache=TRUE}
master.qcew.county <- read_csv("Data/QCEW/Master-qcew-county.csv") %>%
  mutate(key = as.factor(key))

master.qcew.ruca <- read_csv("Data/QCEW/Master-qcew-ruca.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         key = as.factor(key))

master.qcew.pr <- read_csv("Data/QCEW/Master-qcew-pr.csv") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         key = as.factor(key))

master.qcew.edr <- read_csv("Data/QCEW/Master-qcew-edr.csv") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         key = as.factor(key))

master.qcew.mn <- read_csv("Data/QCEW/Master-qcew-mn.csv") %>%
  mutate(key = as.factor(key))

```

```{r master LOST, include=FALSE, cache=TRUE}
master.lost.cities <- read_csv("Data/LOST/Master-local-sales-tax-revenue-cities-2004-2020.csv") %>%
    mutate(local.sales.tax.revenue = str_replace(local.sales.tax.revenue, "-", "0"),
           local.sales.tax.revenue = as.numeric(local.sales.tax.revenue)) %>%
  mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.lost.counties <- read_csv("Data/LOST/master-local-sales-tax-revenue-counties-2004-2020.csv") %>%
  mutate(local.sales.tax.revenue = str_replace(local.sales.tax.revenue, "-", "0"),
         local.sales.tax.revenue = as.numeric(local.sales.tax.revenue),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))


```

<br>

# Summary

<br>

**Job vacancies are still crazy high, maybe even worse than pre-pandemic**

Although there was a slight drop in the job vacancy rate during the pandemic, it continued to still be high across rural Minnesota. And, there was an enormous jump in the job vacancy rate during the first half of 2021 as companies ramped up hiring again. During 2020 the job vacancy rate hovered between 4% and 5.5% (3% is considered healthy), the first half of 2021 saw job vacancy rates increase to between 8% and 10%.

**Drop in people participating in the labor force hit rural regions hardest**

One of the larger negative impacts from the pandemic is the number of people that have left the labor force. Although the drop in the number of people participating in the labor force occurred in all of Minnesota, rural areas were the hardest hit. Rural regions which were already experience little to no growth in their labor force, such as EDRs in the Southwest and Northwest, now have less people participating in the labor force today than they did in 2012!

**The drop in employment worst among females workers in rural areas**

Although employment (note - this isn't labor force) decreased among all genders, the largest decreases occurred among female workers, but only outside of the urban areas. For example, in 2021 the Northwest region had 1% more males employed compared to 2012 yet -3.1% less females employed. And this drop occurred right in 2020 as the previous years saw increases in employment among females. The opposite is true in urban areas where there was a larger drop in male employment compared to female employment.

**This is not a typical economic downturn**

Although the number of people participating in the labor force declines along with overall employment, wages continue to go up significantly. This is not typical of previous economic downturns where employment and wages would decline together. What this tells us is that people are choosing to not work (for many reasons) even though there are plenty of jobs. To try and entice people into the labor pool, employers are increasing wages. Interestingly, the largest decreases in employment have occurred in rural Minnesota while these same regions have experienced the largest wage growth.

**The new remote work fad not occurring as much outside of the seven county metro**

Much has been made about the rise of telecommuting for employment. A report released by MN DEED analyzed job openings and found that there was a rather large disparity in the percentage of jobs allowing telecommuting by region. The seven-county metro had by far the largest percentage of job openings offering telecommuting (13%) followed by Northeast (8.2%) and Southeast (7.5%). It then drops considerably to the remaining regions with Northwest at (2.4%), Central (2.0%), and Southwest (2.0%).

**Significant difference in local options sales tax from Minneapolis**

A sampling of cities that are collecting local option sales tax revenues shows little to no negative impact from the pandemic and in fact may have been helpful. All cities showed rather normal revenue trends in 2021 compared to 2020 while also seeing larger than expected INCREASES in revenues as the pandemic wore on through May and June of 2021. The opposite is true for Minneapolis where LOST fell off a cliff.


<br>

# Job vacancies

The charts below provide the job vacancy rate for each planning region in Minnesota. The job vacancy rate is the average number of job vacancies for the 2nd and 4th quarter of each year divided by the average number of annual filled jobs in the region.

We consider a 3% job vacancy rate to be relatively healthy - it means that there are enough jobs to create healthy opportunity for individuals while also not being too many jobs where employers have an applicant pool.

The job vacancy rate has been increasing across rural Minnesota ever since the Great Recession. In fact, the job vacancy rate in rural Minnesota is the highest in the state - higher than the seven county metro, particularly in Southwest and Northwest Minnesota.

Although the vacancy rate dipped a bit during COVID-19, it isn't enough for it to be a significant issue. The vacancy rate was still significantly higher than 3% across rural Minnesota throughout all of 2020.



<br>

```{r chart job vacancy rate}
jv.rate.trendline.plot <- ggplot(master.jv.pr, aes(year, vacanrate, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nAverage quarterly job vacancies: ", comma(vacancies, accuracy = 1), "\nJob vacancy rate: ", percent(vacanrate, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Job vacancy rate", caption = "\nMN DEED - Job Vacancy Survey") +
  geom_label_repel(data = filter(master.jv.pr, year == max(year)), aes(label = percent(vacanrate, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = jv.rate.trendline.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

We don't currently have the full 2021 data but we do have the data for the first half and as the chart below shows the job vacancy was CRAZY high. Every region is aboe 7% job vacancy rate. The highest was in Northeast Minnesota at nearly 10%, followed by Southeast at 9.4%. 

Interestingly, the Southwest was the lowest with 7.3% however this region was also the least impacted by COVID-19 due to it having a significant number of "essential" businesses and continued to work/operate even during the state mandated shutdown. This means less people left the workforce and once businesses began opening again they weren't searching for so many workers.

<br>

```{r chart job vacancies 2021 2nd quarter}

jv.2021.2q.pr.plot <- ggplot(master.jv.2021.2q.pr, aes(planning.region, vacanrate, fill = planning.region, group = planning.region)) +
    geom_col_interactive(position = "dodge", aes(data_id = planning.region, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nQuarter: Second quarter", "\nAverage number of job vacancies: ", comma(vacancies, accuracy = 1), "\nJob vacancy rate: ", percent(vacanrate, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(vacanrate, accuracy = .1)), show.legend = FALSE, color = "black", size = 5) +
    labs(x="", y = "", color="", title = "Job vacancy rate - 2021 2nd quarter", caption = "MN DEED - Job Vacancy Survey")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
    theme_bar+
    scale_fill_manual(values= color.pr,
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "none",
          text = element_text(size = 18))

  girafe(ggobj = jv.2021.2q.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

# Changes in the labor force{.tabset}

The chart below provides the trend lines for the number of people participating in the labor force since 2012.

In a healthy labor force the trendlines should show a gradual increase each year as more people enter the workforce. However, this isn't always the case, particularly in rural areas where the number of people entering the workforce may not keep up with the number of people leaving the workforce due to retirements.

Before the pandemic, this was the trend we saw across Minnesota. Planning regions with larger, metropolitan cities saw gradual increases in the number of people participating in the workforce. In 2019, the seven county metro had 8% more people participating in the workforce than in 2012 while Central had 6% more.

As planning regions get more rural the less of a increase experienced. For example, in 2019 Southwest Minnesota only had 1% more people in the workforce than in 2012. 

However, once the pandemic hit all regions experienced significant declines and 2021 didn't see much of a recovery. The seven county metro peaked at 10% and dropped to have 4.8% more people participating in the workforce compared to 2012. Central was at 2.6% more, Southeast at 1.3% more and Northwest at .9% more. Southwest and Northeast had less people participating in the workforce in 2021 than they did in 2012 - Northeast had -2.8% less and Southwest had -4.4% less. 

The numbers broken down by EDR shows that the more rural a region is the larger the decrease in the labor force since 2012. For example, EDR 1 - Northwest and EDR 6W - Upper MN Valley show significant drops in their labor force compared to the surrounding EDRs in that planning region.

```{r prep labor force, include=FALSE, cache=TRUE}
lf.pr <- master.lf.pr %>%
  group_by(planning.region) %>%
  mutate(lf.index = (labor.force - labor.force[year == min(.$year)]) / labor.force[year == min(.$year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

lf.edr <- master.lf.edr %>%
  group_by(EDR, planning.region) %>%
  mutate(lf.index = (labor.force - labor.force[year == min(.$year)]) / labor.force[year == min(.$year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

```


<br>

## Planning Region

<br>

```{r chart laborforce trends pr}
lf.pr.plot <- ggplot(lf.pr, aes(year, lf.index, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nLabor force: ", comma(labor.force, accuracy = 1), "\nPercent change in labor force since ", min(lf.pr$year), ": ", percent(lf.index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = paste("Change in labor force since ", min(lf.pr$year), sep = "")) +
  geom_label(data = filter(lf.pr, year == max(lf.pr$year)), aes(label = percent(lf.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = lf.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart laborforce trends edr}
lf.edr.plot <- ggplot(lf.edr, aes(year, lf.index, color = EDR)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(EDR, "\nYear: ", year, "\nLabor force: ", comma(labor.force, accuracy = 1), "\nPercent change in labor force since ", min(lf.pr$year), ": ", percent(lf.index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = paste("Change in labor force since ", min(lf.edr$year), sep = "")) +
  geom_label(data = filter(lf.edr, year == max(lf.edr$year)), aes(label = percent(lf.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = lf.edr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

There has been anecdotal evidence that COVID hit the female workforce the hardest ultimately leading them to leave the workforce. The charts below provide EMPLOYMENT (not workforce) by gender to get a sense of what changes have occurred. This essentially is the breakdown of jobs held by male or female workers.


The RUCA chart shows that although employment decline significantly across all genders in 2020, the hardest hit were female workers in non-entirely urban counties. In our entirely rural, town/rural mix, and urban/town/rural mix county groups female employment dropped more than male employment. However, for our entirely urban group, male employment dropped further than female employment.

The breakdown by planning region shows a similar trend. Regions that have more rural areas within them saw a larger decrease in female employment than male, except for Southeast and in the seven county metro. The uptick in female employment in Southeast is kind of interesting and I'm not entirely sure how that happened.

When broken down by EDR, it's pretty much the same with a couple of exceptions. EDR 1 - Northwest and EDR 6W - Upper MN Valley are both regions that are exceptionally rural yet the decline in the female employment was smaller than males.

Finally, the county map provides a pretty clear picture that female employment declined significantly more across much of rural Minnesota. In particular, the central lakes region and Southwest regions of Minnesota see large differences between female and male employment declines.

<br>

```{r prep employment by gender, include=FALSE, cache=TRUE}
emp.gender.index.county <- master.emp.gender.county %>%
  filter(year > 2011) %>%
  group_by(countyfp, Name, sex) %>%
  mutate(Emp.index = (Emp - Emp[year == min(.$year)]) / Emp[year == min(.$year)]) %>%
  ungroup

emp.gender.index.county.map <- emp.gender.index.county %>%
  filter(year == max(year)) %>%
  mutate(Emp.index.bins = cut(Emp.index,
                              breaks = c(-1, -.2, -.1, 0, .1, 1),
                              labels = c("-20% or less", "-20% to -10%", "-10% to 0%", "0% to 10%", "10% or more"))) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")

emp.gender.index.ruca <- master.emp.gender.county %>%
  filter(year > 2011) %>%
  group_by(Dem_Desc, year, sex) %>%
  summarize(Emp = sum(Emp, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(Dem_Desc, sex) %>%
  mutate(Emp.index = (Emp - Emp[year == min(.$year)]) / Emp[year == min(.$year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

emp.gender.index.pr <- master.emp.gender.county %>%
  filter(year > 2011) %>%
  group_by(planning.region, year, sex) %>%
  summarize(Emp = sum(Emp, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(planning.region, sex) %>%
  mutate(Emp.index = (Emp - Emp[year == min(.$year)]) / Emp[year == min(.$year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

emp.gender.index.edr <- master.emp.gender.county %>%
  filter(year > 2011) %>%
  group_by(edr, planning.region, year, sex) %>%
  summarize(Emp = sum(Emp, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(edr, planning.region, sex) %>%
  mutate(Emp.index = (Emp - Emp[year == min(.$year)]) / Emp[year == min(.$year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

```

## RUCA

<br>

```{r chart employment by gender index ruca}
emp.gender.index.ruca.plot <- ggplot(emp.gender.index.ruca, aes(year, Emp.index, color = sex)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nGender: ", sex, "\nNumber employed: ", comma(Emp), "\nChange in employment since 2012: ", percent(Emp.index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in employment since 2012", caption = "\nU.S. Census Bureau - Quarterly Workforce Indicators")+
  geom_label(data = filter(emp.gender.index.ruca, year == max(year)), aes(label = percent(Emp.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = emp.gender.index.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

<br>

```{r chart employment by gender index pr}
emp.gender.index.pr.plot <- ggplot(emp.gender.index.pr, aes(year, Emp.index, color = sex)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nGender: ", sex, "\nNumber employed: ", comma(Emp), "\nChange in employment since 2012: ", percent(Emp.index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in employment since 2012", caption = "\nU.S. Census Bureau - Quarterly Workforce Indicators")+
  geom_label(data = filter(emp.gender.index.pr, year == max(year)), aes(label = percent(Emp.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = emp.gender.index.pr.plot, width_svg = 10, height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart employment by gender index edr}
emp.gender.index.edr.plot <- ggplot(emp.gender.index.edr, aes(year, Emp.index, color = sex)) +
  facet_wrap(~edr, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nGender: ", sex, "\nNumber employed: ", comma(Emp), "\nChange in employment since 2012: ", percent(Emp.index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in employment since 2012", caption = "\nU.S. Census Bureau - Quarterly Workforce Indicators")+
  geom_label(data = filter(emp.gender.index.edr, year == max(year)), aes(label = percent(Emp.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = emp.gender.index.edr.plot, width_svg = 10, height_svg = 15) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## County map

<br>

```{r map employment index by gender county}
emp.gender.index.county.map.plot <- ggplot(emp.gender.index.county.map) +
  facet_wrap(~sex, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = Emp.index.bins, data_id = countyfp, tooltip = paste(Name, "\nYear: ", year, "\nGender: ", sex, "\nNumber employed: ", comma(Emp, accuracy = 1), "\nChange in employment since 2012: ", percent(Emp.index, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu")) +
  labs(title = "Change in employment since 2012") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = emp.gender.index.county.map.plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```

<br>

# Wages{.tabset}

During a typical economic downturn where employment decreases total wages earned will follow suit - it will either decrease with employment or at a minimum flatten a bit.

The charts below compare the average quarterly employment and total wages earned across Minnesota. Surprisingsly, the decrease in employment due to the pandemic did not translate into a decrease in wages earned. This was a very different animal. 

What the trend lines show is that while employment grew modestly between 2012 and 2019, wages really took off, largely due to the increasing workforce shortage. When 2020 hit and the pandemic induced shutdowns, employment dropped. Surprisingly, wages continued to increase. This is due to the employment decreases not being caused by an economic downturn where people were spending less but rather people either choosing not to work or couldn't work. However, the economy continued to roar.

Even more interesting is seeing the lowest employment growth occuring in our most rural areas of Minnesota while those same areas experiencing the largest increases in total wages.

<br>



```{r prep employment and wages, include=FALSE, cache=TRUE}
qcew.index.county <- master.qcew.county %>%
  filter(year.quarter > 2011.4) %>%
  filter(key %in% c("avgemp", "totwage")) %>%
  droplevels() %>%
  group_by(countyfp, key) %>%
  mutate(index = (value - value[year.quarter == min(.$year.quarter)]) / value[year.quarter == min(.$year.quarter)]) %>%
  ungroup() %>%
  mutate(key = ifelse(key == "avgemp", "Avg employment", "Total wages"))

qcew.index.county.map <- qcew.index.county %>%
  filter(year.quarter == max(year.quarter)) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")

qcew.index.ruca <- master.qcew.ruca %>%
  filter(year.quarter > 2011.4) %>%
  filter(key %in% c("avgemp", "totwage")) %>%
  droplevels() %>%
  group_by(Dem_Desc, key) %>%
  mutate(index = (value - value[year.quarter == min(.$year.quarter)]) / value[year.quarter == min(.$year.quarter)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))%>%
  mutate(key = ifelse(key == "avgemp", "Avg employment", "Total wages"))

qcew.index.pr <- master.qcew.pr %>%
  filter(year.quarter > 2011.4) %>%
  filter(key %in% c("avgemp", "totwage")) %>%
  droplevels() %>%
  group_by(planning.region, key) %>%
  mutate(index = (value - value[year.quarter == min(.$year.quarter)]) / value[year.quarter == min(.$year.quarter)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))%>%
  mutate(key = ifelse(key == "avgemp", "Avg employment", "Total wages"))

qcew.index.edr <- master.qcew.edr %>%
  filter(year.quarter > 2011.4) %>%
  filter(key %in% c("avgemp", "totwage")) %>%
  droplevels() %>%
  group_by(edr, planning.region, key) %>%
  mutate(index = (value - value[year.quarter == min(.$year.quarter)]) / value[year.quarter == min(.$year.quarter)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))%>%
  mutate(key = ifelse(key == "avgemp", "Avg employment", "Total wages"))

```

## RUCA

<br>

```{r chart wage and emp index ruca}
qcew.index.ruca.plot <- ggplot(qcew.index.ruca, aes(year.quarter, index, color = Dem_Desc)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear and quarter: ", year.quarter, "\nCategory: ", key, "\nValue: ", comma(value), "\nIndex to 2012: ", percent(index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in employment and wages since 2012", caption = "MN DEED - QCEW")+
  geom_label(data = filter(qcew.index.ruca, year.quarter == max(year.quarter)), aes(label = percent(index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = qcew.index.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

## Planning Region

<br>

```{r chart wage and emp index pr}
qcew.index.pr.plot <- ggplot(qcew.index.pr, aes(year.quarter, index, color = planning.region)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear and quarter: ", year.quarter, "\nCategory: ", key, "\nValue: ", comma(value), "\nIndex to 2012: ", percent(index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in employment and wages since 2012", caption = "MN DEED - QCEW")+
  geom_label(data = filter(qcew.index.pr, year.quarter == max(year.quarter)), aes(label = percent(index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = qcew.index.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

## EDR

<br>

```{r chart wage and emp index edr}
qcew.index.edr.plot <- ggplot(qcew.index.edr, aes(year.quarter, index, color = edr)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nYear and quarter: ", year.quarter, "\nCategory: ", key, "\nValue: ", comma(value), "\nIndex to 2012: ", percent(index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in employment and wages since 2012", caption = "MN DEED - QCEW")+
  geom_label(data = filter(qcew.index.edr, year.quarter == max(year.quarter)), aes(label = percent(index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = qcew.index.edr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>


# Remote work

MN DEED wrote an [article]("https://mn.gov/deed/newscenter/publications/trends/december-2021/remote-work.jsp") explaining the change in job openings now being offered as remote. The table is taken directly from their report.

It's interesting to see how large of a difference there is between rural and urban areas. There's about a ten percentage point difference between our most rural and most urban regions.

<br>

```{r tabme for remote work}
remote.work.table <- read_xlsx("Data/Telework/telework-table.xlsx") %>%
  mutate(`Share allowing Telework, Jan-Oct 2021` = percent(`Share allowing Telework, Jan-Oct 2021`, accuracy = .1))

kable(format = "html", remote.work.table, escape = F, align = "c") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left") %>%
  scroll_box(width = "100%") 


```

<br>

# Local Options Sales Tax

The chart below provides the monthly revenues from local option sales taxes of a few select cities in each planning region.Unfortunately the data from July 2020 - December 2020 have not yet been published so we are still waiting on those.

The cities chosen below have well-established LOST, meaning they have been in implementation for a few years. It was also an attempt to get a sampling of different types of communities - tourist destinations, manufacturing towns, and smaller communities.

What's really interesting about the trend lines is that there doesn't seem to be an enormous impact to revenues in rural Minnesota due to COVID 19. In fact, revenues from March 2021 on wards seem to follow the same trends and revenues as March 2020. On top of this is a rather large increase in revenues across the rural Minnesota as the pandemic continued (May and June, 2021). This may be a sign that folks chose to shop more locally during the pandemic instead of driving to larger communities as well as an increase in Amazon orders which still collects LOST for the shipping destination community.

This is not true for Minneapolis where revenues fell off a cliff once the pandemic began. Not surprising considering all of the events that were cancelled.

<br>

```{r prep lost, include=FALSE, cache=TRUE}
lost.cities <- master.lost.cities %>%
  filter(Month != "Total",
         local.sales.tax.revenue > 0,
         year %in% c(2019, 2020),
         city %in% c("Baxter", "Fergus Falls", "Cloquet", "Moose Lake", "New London", "Clearwater", "Minneapolis", "Fairmont", "New Ulm", "Albert Lea", "Austin")) %>%
  mutate(year.month = paste(year, "-", Month, sep = ""),
         year.month = ym(year.month),
         city = as.factor(city),
         data_id = seq(n())) %>%
  group_by(year.month, planning.region) %>%
  distinct(city, .keep_all = TRUE) %>%
  ungroup()

```

<br>

```{r chart LOST cities}
lost.cities.plot <- ggplot(lost.cities, aes(year.month, local.sales.tax.revenue, color = city)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free_y") +
  geom_smooth(se = FALSE, size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(city, "\nYear and month: ", year.month, "\nLocal sales tax revenue: ", dollar(local.sales.tax.revenue), sep = ""))) +
  geom_label_repel(data = filter(lost.cities, year == 2019, Month == "August"), aes(label = city), size = 4, show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Monthly local option sales tax revenue, 2019 and 2020") +
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2),
                     guide = guide_axis(n.dodge = 2)) +
  theme_line+
  scale_color_manual(values = brewer.pal(n = 12, "Paired"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = lost.cities.plot, width_svg = 10, height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))
```




