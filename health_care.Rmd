---
title: "Health Care"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(extrafont)
library(readxl)
library(janitor)
library(lubridate)

loadfonts()
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         edr = ifelse(Name == "Minnesota", "Minnesota", edr) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

color.edr.n = c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c")

color.edr.c = c("EDR 6E- Southwest Central" = "#e5f5f9", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

color.edr.s = c("EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r master HAR, include=FALSE, cache=TRUE}
master.har <- read_csv("Data/Hospitals/HAR/Master-har.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
    rename(year = rpt_year) %>%
  rename(`Hospital Name` = 5)
```

```{r master hospital capacity, include=FALSE, cache=TRUE}
master.hosp.cap <- read_csv("Data/Hospitals/Capacity/hospital-capacity.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

<br>

# Summary

**Hospitals in our urban and regional centers bared the greatest burden in treating COVID patients**

The percentage of beds occupied by COVID patients in rural areas throughout the pandemic were surprisingly low. But this is likely due to coordination among hospitals and within health care systems to transport COVID patients to the larger regional hospitals. We will have to talk to Santo to get a better handle on this.

**Hospitals were managing resources depending on demand for certain beds**

The consistent percentages of beds being used is surprising due to the wave-like trends in the pandemic. However, the data showing the number of inpatient and ICU beds available shows that hospitals were actively managing their resources by shifting staff to other types of beds depending on the demand. The number of inpatient and ICU beds available changed significantly and showed a wave-like trends that coincided with the trends of the pandemic. 

**The number of inpatient beds available declining significantly in rural areas**

One aspect that is a bit worrisome is the decline in the number of inpatient beds that continues throughout the pandemic. In our more rural hospitals of Minnesota, the number of inpatient beds available is between 30% and 40% less than what it was on July 31, 2020.

**Rural hospitals were in a precarious financial state immediately before the pandemic**

Although we don't yet have 2020 financial data, the 2019 hospital annual reports showed that hospitals in our rural areas had average profit losses compared to more metropolitan hospitals. 

<br>

# Hospital capacity and COVID-19{.tabset}

The charts below provide the following;

* The percentage of beds occupied by COVID patients
* The percentage of hospital beds occupied (COVID patients plus all other patients)
* The percentage of ICU beds occupied by COVID patients
* The percentage of ICU beds occupied (COVID patients plus all other ICU patients)

The percentage of both hospital beds and ICU beds used by COVID patients was highest when a hospital was located in a more urban region. It's likely that how health care operates, and the increasing regionalization of health care plays a role in these trends. A conversation with Santo might be helpful but I'm guessing that many of the larger healthcare systems coordinated so that COVID patients in their system were transported to more regional hospitals instead of outfitting the smaller hospitals with COVID-ready rooms.

<br>

```{r prep hospital capacity, include=FALSE, cache=TRUE}
hosp.cap.ruca <- master.hosp.cap %>%
  gather(key = "key", value = "patients", 5:11) %>%
  filter(patients != -999999) %>%
  group_by(Dem_Desc, collection_week, key) %>%
  summarise(patients = sum(patients, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(key = key, value = patients) %>%
  mutate(pct.hosp.beds.covid = (`total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg` + `total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg`) / `inpatient_beds_7_day_avg`,
         pct.icu.beds.covid = `staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg` / `total_staffed_adult_icu_beds_7_day_avg`,
         pct.all.hosp.beds.occ = `inpatient_beds_used_7_day_avg` / `inpatient_beds_7_day_avg`,
         pct.all.icu.beds.occ = `staffed_adult_icu_bed_occupancy_7_day_avg` / `total_staffed_adult_icu_beds_7_day_avg`) %>%
  gather(key = "key", value = "pct", 10:13) %>%
  mutate(key = str_replace(key, "pct.all.hosp.beds.occ", "% of all hospital beds occupied"),
         key = str_replace(key, "pct.all.icu.beds.occ", "% of all ICU beds occupied"),
         key = str_replace(key, "pct.hosp.beds.covid", "% of hospital beds occupied by COVID patients"),
         key = str_replace(key, "pct.icu.beds.covid", "% of ICU beds occupied by COVID patients"),
         key = fct_relevel(key, "% of hospital beds occupied by COVID patients", "% of all hospital beds occupied", "% of ICU beds occupied by COVID patients", "% of all ICU beds occupied"))

hosp.cap.pr <- master.hosp.cap %>%
  gather(key = "key", value = "patients", 5:11) %>%
  filter(patients != -999999) %>%
  group_by(planning.region, collection_week, key) %>%
  summarise(patients = sum(patients, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(key = key, value = patients) %>%
  mutate(pct.hosp.beds.covid = (`total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg` + `total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg`) / `inpatient_beds_7_day_avg`,
         pct.icu.beds.covid = `staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg` / `total_staffed_adult_icu_beds_7_day_avg`,
         pct.all.hosp.beds.occ = `inpatient_beds_used_7_day_avg` / `inpatient_beds_7_day_avg`,
         pct.all.icu.beds.occ = `staffed_adult_icu_bed_occupancy_7_day_avg` / `total_staffed_adult_icu_beds_7_day_avg`) %>% 
  gather(key = "key", value = "pct", 10:13) %>%
  mutate(key = str_replace(key, "pct.all.hosp.beds.occ", "% of all hospital beds occupied"),
         key = str_replace(key, "pct.all.icu.beds.occ", "% of all ICU beds occupied"),
         key = str_replace(key, "pct.hosp.beds.covid", "% of hospital beds occupied by COVID patients"),
         key = str_replace(key, "pct.icu.beds.covid", "% of ICU beds occupied by COVID patients"),
         key = fct_relevel(key, "% of hospital beds occupied by COVID patients", "% of all hospital beds occupied", "% of ICU beds occupied by COVID patients", "% of all ICU beds occupied"))



hosp.cap.edr <- master.hosp.cap %>%
  gather(key = "key", value = "patients", 5:11) %>%
  filter(patients != -999999) %>%
  group_by(edr, planning.region, collection_week, key) %>%
  summarise(patients = sum(patients, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(key = key, value = patients) %>%
  mutate(pct.hosp.beds.covid = (`total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg` + `total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg`) / `inpatient_beds_7_day_avg`,
         pct.icu.beds.covid = `staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg` / `total_staffed_adult_icu_beds_7_day_avg`,
         pct.all.hosp.beds.occ = `inpatient_beds_used_7_day_avg` / `inpatient_beds_7_day_avg`,
         pct.all.icu.beds.occ = `staffed_adult_icu_bed_occupancy_7_day_avg` / `total_staffed_adult_icu_beds_7_day_avg`) %>%
  gather(key = "key", value = "pct", 11:14) %>%
  mutate(key = str_replace(key, "pct.all.hosp.beds.occ", "% of all hospital beds occupied"),
         key = str_replace(key, "pct.all.icu.beds.occ", "% of all ICU beds occupied"),
         key = str_replace(key, "pct.hosp.beds.covid", "% of hospital beds occupied by COVID patients"),
         key = str_replace(key, "pct.icu.beds.covid", "% of ICU beds occupied by COVID patients"),
         key = fct_relevel(key, "% of hospital beds occupied by COVID patients", "% of all hospital beds occupied", "% of ICU beds occupied by COVID patients", "% of all ICU beds occupied"))

```

## RUCA

<br>

```{r chart hosp cap}
hosp.cap.ruca.plot <- ggplot(hosp.cap.ruca, aes(collection_week, pct, color = Dem_Desc)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  labs(x="", y = "", color="", title = "Percent of beds by type", caption = "\nU.S. Department of Health & Human Services - COVID-19 Reported Patient Impact and Hospital Capacity by Facility")+
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = hosp.cap.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

## Planning Region

<br>

```{r chart hosp cap pr} 
hosp.cap.pr.plot <- ggplot(hosp.cap.pr, aes(collection_week, pct, color = planning.region)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  labs(x="", y = "", color="", title = "Percent of beds by type", caption = "\nU.S. Department of Health & Human Services - COVID-19 Reported Patient Impact and Hospital Capacity by Facility")+
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = hosp.cap.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

## EDR{.tabset .tabset-pills}

<br>

### North

<br>

```{r chart hosp cap edr northwest} 
hosp.cap.edr.n.plot <- ggplot(data = filter(hosp.cap.edr, planning.region %in% c("Northwest", "Northeast")), aes(collection_week, pct, color = edr)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  labs(x="", y = "", color="", title = "Percent of beds by type", caption = "\nU.S. Department of Health & Human Services - COVID-19 Reported Patient Impact and Hospital Capacity by Facility")+
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.edr.n,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = hosp.cap.edr.n.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>


### Central

<br>

```{r chart hosp cap edr central} 
hosp.cap.edr.c.plot <- ggplot(data = filter(hosp.cap.edr, planning.region %in% c("Central", "Seven County Mpls-St Paul")), aes(collection_week, pct, color = edr)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  labs(x="", y = "", color="", title = "Percent of beds by type", caption = "\nU.S. Department of Health & Human Services - COVID-19 Reported Patient Impact and Hospital Capacity by Facility")+
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.edr.c,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = hosp.cap.edr.c.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### Southwest

<br>

```{r chart hosp cap edr south} 
hosp.cap.edr.s.plot <- ggplot(data = filter(hosp.cap.edr, planning.region %in% c("Southwest", "Southeast")), aes(collection_week, pct, color = edr)) +
  facet_wrap(~key, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 3) +
  labs(x="", y = "", color="", title = "Percent of beds by type", caption = "\nU.S. Department of Health & Human Services - COVID-19 Reported Patient Impact and Hospital Capacity by Facility")+
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.edr.s,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = hosp.cap.edr.s.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

One aspect that doesn't get discussed much is how hospitals needed to shift resources and staff to different "beds" depending on staff availability and need. The charts below provide the number of inpatient and ICU beds each week as a percentage of the number of beds that were available at the earliest data point which is July 31, 2020.

The first thing that is noticeable when reviewing the charts is that there were very few ICU beds available in our entirely rural hospitals. The data suppressed information if there was less than 4 beds so it could be that there were 1 to 3 beds available but the data shows 0. 

Another trend is that the number of ICU beds as a percentage of the number on July 31, 2020 is that they went up and down and it seems to coincide with the waves of the virus. Beds would increase as Delta and Omicron waves hit. This indicates that hospitals were actively adjusting resources and staff according to the demand.

Another noticeable trend is that ICU beds staffed in our entirely urban hospitals stayed high and consistent. They never dropped below the number of ICU beds staffed in July 31, 2020. This is not true for hospitals that are more rural. As the pandemic continued the number of ICU beds decreased significantly, particularly in our town/rural mix counties. The reason for this is unknown, but it could be due to hospital systems shifting ICU to their larger hospitals in urban areas as well as staffing issues.

The trend of the number of inpatient beds compared to July 31, 2020 is quite striking. Significant declines in the number of beds available across Minnesota. The declines were most severe in our town/rural mix counties and urban/town/rural mix counties.

When looking at the data by region, we can see that the seven-county mpls-st paul region kept a considerably high number of ICU beds throughout the pandemic. The Southeast hospitals kept a very consistent number as well. Hospitals outside of these regions had a much more fluctuating number of ICU bed and most recently have seen significant decline in the number of ICU beds.

The inpatient beds shows declines throughout all regions but the most severe are in Southwest, Northwest, and Central Minnesota. 

It's challenging to know the exact reasons for these trends. It's likely due to a combination of hospitals managing resources and increasing staffing levels for certain types of beds depending on demand coupled with staffing levels declining due to people dropping out of the workforce in health care. However, what this does make clear is that the percentages of beds taken were not necessarily a good indicator of the severity of the issue since hospitals were actively changing the number of beds available on a weekly basis. This would explain why the percentages were so consistent. As more ICU beds were needed, they increased the staffing of those beds in order to meet the demand.

<br>

```{r prep number of beds variability, include=FALSE, cache=TRUE}
bed.var.ruca <- hosp.cap.ruca %>%
  spread(key = key, value = pct) %>%
  select(1:3, 9) %>%
  rename(inpatient.beds = 3,
         icu.beds = 4) %>%
  group_by(Dem_Desc) %>%
  mutate(inpatient.beds.index = (inpatient.beds - inpatient.beds[collection_week == min(collection_week)]) / inpatient.beds[collection_week == min(collection_week)],
         icu.beds.index = (icu.beds - icu.beds[collection_week == min(collection_week)]) / icu.beds[collection_week == min(collection_week)]) %>%
  ungroup() %>%
  mutate(icu.beds.index = ifelse(Dem_Desc == "Entirely rural", 0, icu.beds.index)) %>%
  gather(key = "index.type", value = "index", 5:6) %>%
  mutate(data_id = seq(n()))

bed.var.pr <- hosp.cap.pr %>%
  spread(key = key, value = pct) %>%
  select(1:3, 9) %>%
  rename(inpatient.beds = 3,
         icu.beds = 4) %>%
  group_by(planning.region) %>%
  mutate(inpatient.beds.index = (inpatient.beds - inpatient.beds[collection_week == min(collection_week)]) / inpatient.beds[collection_week == min(collection_week)],
         icu.beds.index = (icu.beds - icu.beds[collection_week == min(collection_week)]) / icu.beds[collection_week == min(collection_week)]) %>%
  ungroup() %>%
  gather(key = "index.type", value = "index", 5:6) %>%
  mutate(data_id = seq(n()))

bed.var.edr <- hosp.cap.edr %>%
  spread(key = key, value = pct) %>%
  select(1:4, 9) %>%
  rename(inpatient.beds = 4,
         icu.beds = 5) %>%
  group_by(edr, planning.region) %>%
  mutate(inpatient.beds.index = (inpatient.beds - inpatient.beds[collection_week == min(collection_week)]) / inpatient.beds[collection_week == min(collection_week)],
         icu.beds.index = (icu.beds - icu.beds[collection_week == min(collection_week)]) / icu.beds[collection_week == min(collection_week)]) %>%
  ungroup() %>%
  gather(key = "index.type", value = "index", 6:7) %>%
  mutate(data_id = seq(n()))
```

## RUCA

<br>

```{r chart number of beds variability ruca}
bed.var.ruca.plot <- ggplot(bed.var.ruca, aes(collection_week, index, color = Dem_Desc)) +
  facet_wrap(~index.type, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 1.5) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nDate: ", collection_week, "\nNumber of inpatient beds staffed: ", comma(inpatient.beds, accuracy = 1), "\nNumber of icu beds staffed: ", comma(icu.beds, accuracy = 1),"\nChange in ", index.type, " since ", min(bed.var.ruca$collection_week), ": ", percent(index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = paste("Change in values since ", min(bed.var.ruca$collection_week), sep = "")) +
  geom_label_repel(data = filter(bed.var.ruca, collection_week == max(collection_week)), aes(label = percent(index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent) +
  theme_line +
  scale_color_manual(values = color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = bed.var.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

## Planning Region

<br>

```{r chart number of beds variability pr}
bed.var.pr.plot <- ggplot(bed.var.pr, aes(collection_week, index, color = planning.region)) +
  facet_wrap(~index.type, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(se = FALSE, size = 1.5) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(planning.region, "\nDate: ", collection_week, "\nNumber of inpatient beds staffed: ", comma(inpatient.beds, accuracy = 1), "\nNumber of icu beds staffed: ", comma(icu.beds, accuracy = 1),"\nChange in ", index.type, " since ", min(bed.var.ruca$collection_week), ": ", percent(index, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = paste("Change in values since ", min(bed.var.pr$collection_week), sep = "")) +
  geom_label_repel(data = filter(bed.var.pr, collection_week == max(collection_week)), aes(label = percent(index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent) +
  theme_line +
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = bed.var.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>


# Hospital margins{.tabset}

Margins is the net profit or net loss as a percent of total revenue for a hospital. A healthy margin (i.e. profit) is considered 4% which means the hospital was able to pay for all of its expenses and has some money remaining to make further investments in the facility, staff, equipment, etc...

Unfortunately, data for 2020 has not yet been released and, in fact, the 2019 data was just released last month. It's going to be a while before we can see the 2020 data. However, looking at the financial health of our hospitals before the pandemic can set the stage as to why providing funds to our hospitals during the pandemic was essential to their financial standing.

The chart below provides the average margin of all the hospitals within a county group or region. What they show is that typically a hospital located within a more metropolitan region will likely have higher margins. In fact, hospitals within Entirely Urban counties average a 4.5% margin in 2019. However, hospitals operating within entirely rural counties average a net loss margin of 1.2%. 

Interestingly, when viewing these numbers by region we see that the hospital margins in our entirely urban counties was not necessarily led by the seven county metro. The average margins there have been hovering around 4% until 2019 when it dropped to 2.2%. The highest margins are actually at hospitals in Central Minnesota where they had a 6.6% margin in 2019, which was actually down from it's peak in 2016 when it was nearly 10%.

Essentially, the federal dollars that went to our health care institutions during the pandemic were likely a lifeline. Cutting off their source of revenues by not allowing non-life threatening medical procedures to proceed during the beginning of the pandemic would have killed these institutions in our rural areas. They are barely hanging on as it is.


<br>

```{r prep margins for each hospital, include = FALSE, cache=TRUE}
har.margins <- master.har %>%
  filter(code %in% c(200, 250),
         year > 2015) %>%
  group_by(hccis_id, year, code, `Hospital Name`) %>%
  distinct(value, .keep_all = TRUE) %>%
  ungroup() %>%
  mutate(code = ifelse(code == 200, "income.loss", "total.revenue"),
         value = as.numeric(value),
         CAH = ifelse(CAH == "No", "Non-CAH", "CAH")) %>%
  spread(key = code, value = value) %>%
  mutate(margins = income.loss / total.revenue,
         `Hospital Name` = str_replace(`Hospital Name`, "'", ""),
         data_id = seq(n()))
  
```

```{r prep average margins, include = FALSE}

har.margins.avg.ruca <- har.margins %>%
  group_by(year, Dem_Desc) %>%
  summarise(avg.margins = mean(margins, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

har.margins.avg.pr <- har.margins %>%
  group_by(year, planning.region) %>%
  summarise(avg.margins = mean(margins, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

har.margins.avg.edr <- har.margins %>%
  group_by(year, edr, planning.region) %>%
  summarise(avg.margins = mean(margins, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

## RUCA

<br>

```{r chart margins points ruca}
har.margins.avg.ruca.plot <- ggplot(har.margins.avg.ruca, aes(year, avg.margins, color = Dem_Desc)) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nAverage margins: ", percent(avg.margins, accuracy = .1), sep = ""))) +
  geom_smooth(se = FALSE, size = 3) +
    geom_hline(yintercept = 0.04, color = "red") +
  geom_hline(yintercept = 0, color = "black") +
  geom_label_repel(data = filter(har.margins.avg.ruca, year == max(year)), aes(label = percent(avg.margins, accuracy = .1)), show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Average margins of hospitals", caption = "\nMN Department of Health - Hospital Annual Reports")+
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))
      
girafe(ggobj = har.margins.avg.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

<br>

```{r chart margins points pr}
har.margins.avg.pr.plot <- ggplot(har.margins.avg.pr, aes(year, avg.margins, color = planning.region)) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nAverage margins: ", percent(avg.margins, accuracy = .1), sep = ""))) +
  geom_smooth(se = FALSE, size = 3) +
    geom_hline(yintercept = 0.04, color = "red") +
  geom_hline(yintercept = 0, color = "black") +
  geom_label_repel(data = filter(har.margins.avg.pr, year == max(year)), aes(label = percent(avg.margins, accuracy = .1)), show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Average margins of hospitals", caption = "\nMN Department of Health - Hospital Annual Reports")+
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))
      
girafe(ggobj = har.margins.avg.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart margins points edr}
har.margins.avg.edr.plot <- ggplot(har.margins.avg.edr, aes(year, avg.margins, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nAverage margins: ", percent(avg.margins, accuracy = .1), sep = ""))) +
  geom_smooth(se = FALSE, size = 3) +
    geom_hline(yintercept = 0.04, color = "red") +
  geom_hline(yintercept = 0, color = "black") +
  geom_label_repel(data = filter(har.margins.avg.edr, year == max(year)), aes(label = percent(avg.margins, accuracy = .1)), show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Average margins of hospitals", caption = "\nMN Department of Health - Hospital Annual Reports")+
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))
      
girafe(ggobj = har.margins.avg.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

The charts below provide the average percentage of hospitals that had a "healthy margin" each year.

Not surprisingly, the more rural a county or region is, the lower the percentage of hospitals that had a healthy margin at the end of the year.

By 2019, 37.5% of hospitals in entirely rural counties ended the year with a profit margin of 4% or more compared to 54.5% of hospitals in entirely urban counties.

When broken down by region, hospitals in Central Minnesota were significantly healthier with 70% of hospitals have a profit margin of 4% or more. The other regions averaged 50% of hospitals (seven county metro) to 33% in Southwest and Northeast.

Again, this illustrates the precarious financial situation many of our hospitals are facing as they were launched into a pandemic that added significant amount of uncertainty regarding their revenue sources.

<br>

```{r prep pct of hospitals with healthy margin, include=FALSE, cache=TRUE}
har.margins.threshold.ruca <- har.margins %>%
  mutate(below.threshold = ifelse(margins < .04, 1, 0)) %>%
  group_by(Dem_Desc, year) %>%
  summarise(below.threshold = sum(below.threshold, na.rm = TRUE),
            total.n = n()) %>%
  ungroup() %>%
  mutate(above.threshold = total.n - below.threshold,
         pct.above.threshold = above.threshold / total.n,
         pct.below.threshold = below.threshold / total.n,
         data_id = seq(n()))

har.margins.threshold.pr <- har.margins %>%
  mutate(below.threshold = ifelse(margins < .04, 1, 0)) %>%
  group_by(planning.region, year) %>%
  summarise(below.threshold = sum(below.threshold, na.rm = TRUE),
            total.n = n()) %>%
  ungroup() %>%
  mutate(above.threshold = total.n - below.threshold,
         pct.above.threshold = above.threshold / total.n,
         pct.below.threshold = below.threshold / total.n,
         data_id = seq(n()),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

har.margins.threshold.edr <- har.margins %>%
  mutate(below.threshold = ifelse(margins < .04, 1, 0)) %>%
  group_by(edr, planning.region, year) %>%
  summarise(below.threshold = sum(below.threshold, na.rm = TRUE),
            total.n = n()) %>%
  ungroup() %>%
  mutate(above.threshold = total.n - below.threshold,
         pct.above.threshold = above.threshold / total.n,
         pct.below.threshold = below.threshold / total.n,
         data_id = seq(n()),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

## RUCA

<br>

```{r chart margins thresholds ruca}
har.margins.threshold.ruca.plot <- ggplot(har.margins.threshold.ruca, aes(year, pct.above.threshold, color = Dem_Desc)) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nTotal number of hospitals: ", comma(total.n, accuracy = 1), "\nNumber of hospitals above 4% margins: ", comma(above.threshold, accuracy = .1), "\nPercent of hospitals above 4% margin: ", percent(pct.above.threshold, accuracy = .1), sep = ""))) +
  geom_smooth(se = FALSE, size = 3) +
  geom_hline(yintercept = 0, color = "black") +
  geom_label_repel(data = filter(har.margins.threshold.ruca, year == max(year)), aes(label = percent(pct.above.threshold, accuracy = .1)), show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Percentage of hospitals above 4% margins", caption = "\nMN Department of Health - Hospital Annual Reports")+
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))
      
girafe(ggobj = har.margins.threshold.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```


<br>

## Planning Region

<br>

```{r chart margins thresholds pr}
har.margins.threshold.pr.plot <- ggplot(har.margins.threshold.pr, aes(year, pct.above.threshold, color = planning.region)) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nTotal number of hospitals: ", comma(total.n, accuracy = 1), "\nNumber of hospitals above 4% margins: ", comma(above.threshold, accuracy = .1), "\nPercent of hospitals above 4% margin: ", percent(pct.above.threshold, accuracy = .1), sep = ""))) +
  geom_smooth(se = FALSE, size = 3) +
  geom_hline(yintercept = 0, color = "black") +
  geom_label_repel(data = filter(har.margins.threshold.pr, year == max(year)), aes(label = percent(pct.above.threshold, accuracy = .1)), show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Percentage of hospitals above 4% margins", caption = "\nMN Department of Health - Hospital Annual Reports")+
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))
      
girafe(ggobj = har.margins.threshold.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

## EDR 

<br>

```{r chart margins thresholds edr}
har.margins.threshold.edr.plot <- ggplot(har.margins.threshold.edr, aes(year, pct.above.threshold, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nTotal number of hospitals: ", comma(total.n, accuracy = 1), "\nNumber of hospitals above 4% margins: ", comma(above.threshold, accuracy = .1), "\nPercent of hospitals above 4% margin: ", percent(pct.above.threshold, accuracy = .1), sep = ""))) +
  geom_smooth(se = FALSE, size = 3) +
  geom_hline(yintercept = 0, color = "black") +
  geom_label_repel(data = filter(har.margins.threshold.edr, year == max(year)), aes(label = percent(pct.above.threshold, accuracy = .1)), show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Percentage of hospitals above 4% margins", caption = "\nMN Department of Health - Hospital Annual Reports")+
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))
      
girafe(ggobj = har.margins.threshold.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>


