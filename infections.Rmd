---
title: "Infections"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(extrafont)
library(readxl)
library(janitor)
library(lubridate)

loadfonts()
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29")

color.ruca.spec <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "7-County" = "black")


color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r master infections, include=FALSE, cache=TRUE}
master.cases <- read_csv("Data/Cases/Master-covid-cases-counties.csv") %>%
  gather(key = "date", value = "cases", 3:645) %>%
  mutate(date = mdy(date),
         cases = as.numeric(cases),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC")) %>%
  drop_na(cases)

master.deaths <- read_csv("Data/Cases/Master-covid-deaths-counties.csv") %>%
  gather(key = "date", value = "deaths", 3:643) %>% 
  mutate(date = mdy(date),
         deaths = as.numeric(deaths),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC")) %>%
  drop_na(deaths)

```

```{r master vaccinations, include=FALSE, cache=TRUE}
master.vaccinations <- read_csv("Data/Vaccinations/Master-vaccinations-counties.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

master.vaccinations.race <- read_csv("Data/Vaccinations/Vaccinations by Race and Ethnicity_tcm1148-470631.csv") %>%
  mutate(`Age group` = str_replace(`Age group`, "11-May", "5-11"),
         `Age group` = str_replace(`Age group`, "18-Dec", "12-18"))

```

<br>

# Summary

**Infection rate was highest in our more city/rural areas of the state**

Interestingly, the cumulative cases per 100,000 shows that the counties with the highest COVID rates were in our urban/town/rural county group (22,424 per 100,000) and our town/rural county group (21,998 per 100,000). These were following by entirely urban county group (20,324 per 100,000) and our entirely urban group (18,568 per 100,000). One would think that the counties with the densest population would have the highest case rate. However, one theory is that both the urban/town/rural counties and the town/rural counties were just dense enough to spread the virus while also being more reluctant to take precautions to stop the spread. To test this idea, the seven county metro was removed from the "Entirely urban" county group and sure enough, the entirely urban county group (sans 7-county metro) had the highest cases per 100,000. 

**High infection rates in greater Minnesota could be do to industry make-up**

Infections per 100,000 in greater Minnesota were highest in counties that have a large manufacturing employment sector (including food processing). Counties such as Kandiyohi, Roseau, Nobles, and counties surrounding Waseca and Mower had the highest cases per 100,000 in the entire state. However, these counties also have a high employment in manufacturing which were kept open during the beginning of the pandemic due to their "essential" status. Large spreader events occurred in these plants which likely drove up the case count.


**Highest death rates from COVID are in our rural areas**

Most interesting is that although our most rural areas had the lowest cumulative cases per 100,000, they unfortunately had the highest death rate of all counties. Entirely rural counties had a death rate of 275 per 100,000 throughout the pandemic. The lowest was in our entirely urban counties with 188 deaths per 100,000. This is most likely due to the fact that rural areas have a larger percentage of their population that is older, sicker, and have a higher percentage of people with co-morbidity. Interestingly, the same counties that had the highest case rates (Kandiyohi, Roseau, etc...) did not have the highest death rates indicating that the virus spread through a healthier population in those counties. In addition to these factors, the higher death rate in our rural areas likely has to do with the fact mentioned in our next highlight....

**Significantly lower vaccination rates in rural areas**

The highest vaccination rate exists in our entirely urban counties with around 75% of their population having the full series of shots. Our rural areas had between 60% and 65% of their population with the full series of shots. The lowest percentages exist in the counties just north of the twin cities metro where many of those counties barely have 50% of their population vaccinated with not even one shot. There were some rural regions that were surprising however. Counties in Southwest and Northeast in particular had some of the highest vaccination rates in Greater Minnesota.

**The lowest vaccination rates are among American Indian populations**

The percentage of American Indians vaccinated with at least one dose was the lowest among all race and ethnicity with 60.3% and only 53.5% with the complete vaccination series. Asian and Pacific Islanders have the highest with over 85% with at least one dose followed by whites and Hispanic with 70.5%.

<br>

# Cases{.tabset}

Active cases are estimates of the current number of people currently infected with COVID-19. This estimate is calculated by subtracting the number of cumulative cases for each day minus the total cumulative cases from two weeks prior. 

The trend lines of active cases per 100,000 show a wave like pattern as we would expect in a pandemic, with the first wave occurring during the 2020-2021 fall, then the delta wave, and the most recent omicron wave. 

Although all regions and county groups follow this trend, counties and regions in rural areas of the state had higher peaks throughout the pandemic, particularly in the 2020-2021 fall wave. The urban/town/rural mix and town/rural mix had some of the highest rates in the state. However, the most recent omicron wave has been slightly lower in our entirely rural and town/rural mix counties compared to the other county groups.

This trend follows into regional breakdowns where our more rural areas of the state had higher peak rates compared to the seven county metro. The most recent omicron wave has hit the Southeast particularly hard. 

<br>

```{r prep active cases, include=FALSE, cache=TRUE}
active.cases <- master.cases %>%
  group_by(county) %>%
  mutate(active.cases = ifelse(date < as_date("2020-05-16"), 0, cases - lag(cases, n = 14))) %>%
  ungroup()

active.cases.ruca <- active.cases %>%
  group_by(Dem_Desc, date) %>%
  summarise(pop = sum(pop),
            active.cases = sum(active.cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(active.cases.per.100000 = (active.cases / pop) * 100000,
         data_id = seq(n()))

active.cases.pr <- active.cases %>%
  group_by(planning.region, date) %>%
  summarise(pop = sum(pop),
            active.cases = sum(active.cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(active.cases.per.100000 = (active.cases / pop) * 100000,
         data_id = seq(n()))

active.cases.edr <- active.cases %>%
  group_by(edr, planning.region, date) %>%
  summarise(pop = sum(pop),
            active.cases = sum(active.cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(active.cases.per.100000 = (active.cases / pop) * 100000,
         data_id = seq(n()))
```

## RUCA

<br>

```{r chart active cases per 100000 ruca}
active.cases.ruca.plot <- ggplot(active.cases.ruca, aes(date, active.cases.per.100000, color = Dem_Desc)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nDate: ", date, "\nActive cases: ", comma(active.cases, accuracy = 1), "\nActive cases per 100,000: ", comma(active.cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Active cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(active.cases.ruca, date == max(date)), aes(label = comma(active.cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = active.cases.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

<br>

```{r chart active cases per 100000 pr}
active.cases.pr.plot <- ggplot(active.cases.pr, aes(date, active.cases.per.100000, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(planning.region, "\nDate: ", date, "\nActive cases: ", comma(active.cases, accuracy = 1), "\nActive cases per 100,000: ", comma(active.cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Active cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(active.cases.pr, date == max(date)), aes(label = comma(active.cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = active.cases.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart active cases per 100000 edr}
active.cases.edr.plot <- ggplot(active.cases.edr, aes(date, active.cases.per.100000, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(edr, "\nDate: ", date, "\nActive cases: ", comma(active.cases, accuracy = 1), "\nActive cases per 100,000: ", comma(active.cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Active cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(active.cases.edr, date == max(date)), aes(label = comma(active.cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = active.cases.edr.plot, width_svg = 10, height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>



# {.unlisted .toc-ignore .unnumbered .tabset}

<br>

The charts below are the cumulative COVID cases.

The urban/town/rural mix and town/rural mix county groups have the highest cumulative case rate in the state with 22,424 and 21,998 per 100,000 as of February 1st, 2022. Our entirely rural county group has remained slightly below compared to the other county groups As of February 1st, 2022, they had a cumulative COVID case rate of 18,569 per 100,000 which was the lowest out of all the RUCA groups.

When broken down by region, the Central and Southeast planning regions have the highest cumulative cases per 100,000 with 24,432 and 24,058 respectively. The lowest rates have been in the seven county metro and Northeast Minneapolis.

<br>

```{r prep cases, include=FALSE, cache=TRUE}
cases.per.100000.ruca <- master.cases %>%
  group_by(Dem_Desc, date) %>%
  summarize(pop = sum(pop, na.rm = TRUE),
            cases = sum(cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(cases.per.100000 = (cases / pop) * 100000,
         data_id = seq(n()))

cases.per.100000.pr <- master.cases %>%
  group_by(planning.region, date) %>%
  summarize(pop = sum(pop, na.rm = TRUE),
            cases = sum(cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(cases.per.100000 = (cases / pop) * 100000,
         data_id = seq(n()))

cases.per.100000.edr <- master.cases %>%
  group_by(edr, planning.region, date) %>%
  summarize(pop = sum(pop, na.rm = TRUE),
            cases = sum(cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(cases.per.100000 = (cases / pop) * 100000,
         data_id = seq(n()))
```

## RUCA

<br>

```{r chart cases per 100000 ruca}
cases.per.100000.ruca.plot <- ggplot(cases.per.100000.ruca, aes(date, cases.per.100000, color = Dem_Desc)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nDate: ", date, "\nCumulative cases: ", comma(cases, accuracy = 1), "\nCumulative cases per 100,000: ", comma(cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(cases.per.100000.ruca, date == max(date)), aes(label = comma(cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = cases.per.100000.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

<br>

```{r chart cases per 100000 pr}
cases.per.100000.pr.plot <- ggplot(cases.per.100000.pr, aes(date, cases.per.100000, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(planning.region, "\nDate: ", date, "\nCumulative cases: ", comma(cases, accuracy = 1), "\nCumulative cases per 100,000: ", comma(cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(cases.per.100000.pr, date == max(date)), aes(label = comma(cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = cases.per.100000.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart cases per 100000 edr}
cases.per.100000.edr.plot <- ggplot(cases.per.100000.edr, aes(date, cases.per.100000, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(edr, "\nDate: ", date, "\nCumulative cases: ", comma(cases, accuracy = 1), "\nCumulative cases per 100,000: ", comma(cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(cases.per.100000.edr, date == max(date)), aes(label = comma(cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = cases.per.100000.edr.plot, width_svg = 10, height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

Culture, willingness to believe in preventative measures to stop the spread of COVID, as well as industry/employment makeup (think meat packing plants) in a region all likely played a role in the varied spread of COVID in each region. One way to test this idea is to see if entirely urban counties differed significantly in cases depending on whether the entirely urban county was located in the seven county metro or Greater Minnesota.

The RUCA special chart provides the cumulative cases per 100,000 with the 7-county metro broken away from the "entirely urban" county group. This significantly changes the numbers compared to the traditional RUCA chart in the section above. Instead of entirely urban county group being rather low in terms of cumulative cases per 100,000, it is now the highest with 23,256 cumulative cases per 100,000. The seven-county metro counties are the second LOWEST with 19,889 cases per 100,000.

It's fair to say that culture and following public health guidelines played a role in this, but we also can't ignore some of the other reasons such as industry makeup. There are a lot of counties in Greater Minnesota (including entirely urban ones) that have significant manufacturing employers where CDC guidelines were likely hard to follow. We can all remember some of the breakouts that occurred at the beginning of the pandemic when there were super spreaders events occurring at employers that were "essential" and did not close.

The map below really points this out. There are counties such as Nobles, Kandiyohi, the counties around Waseca and Mower, as well as Roseau which all had very high cases per 100,000. These counties also have plants that never shut down and had super spreader events. 

<br>

```{r prep special ruca cumulative cases per 100,000 ruca with seven county split out, include=FALSE, cache=TRUE}
cum.cases.ruca.spec <- master.cases %>%
  mutate(ruca.spec = ifelse(planning.region == "Seven County Mpls-St Paul", "7-County", as.character(Dem_Desc)),
         ruca.spec = fct_relevel(ruca.spec, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban", "7-County")) %>%
  group_by(ruca.spec, date) %>%
  summarise(pop = sum(pop, na.rm = TRUE),
            cases = sum(cases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(cases.per.100000 = (cases / pop) * 100000,
         data_id = seq(n()))

cum.cases.county.map <- master.cases %>%
  mutate(cases.per.100000 = (cases / pop) * 100000) %>%
  filter(date == max(date)) %>%
  mutate(cases.per.100000.bins = cut(cases.per.100000,
                                     breaks = c(0, 17500, 20000, 22500, 25000, 40000),
                                     labels = c("Less than 17,500 per 1000,000", "17,500 to 20,000 per 100,000", "20,000 to 22,500 per 100,000", "22,500 to 25,000 per 100,000", "More than 25,000 per 100,000"))) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")

```

## RUCA special

<br>

```{r chart special ruca cum cases per 100,000}
cum.cases.ruca.spec.plot <- ggplot(cum.cases.ruca.spec, aes(date, cases.per.100000, color = ruca.spec)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(ruca.spec, "\nDate: ", date, "\nCumulative cases: ", comma(cases, accuracy = 1), "\nCumulative cases per 100,000: ", comma(cases.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative cases per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(cum.cases.ruca.spec, date == max(date)), aes(label = comma(cases.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.ruca.spec,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = cum.cases.ruca.spec.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## Map of counties

<br>

```{r map cumulative cases per 100000}
cum.cases.county.map.plot <- ggplot(cum.cases.county.map) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = cases.per.100000.bins, data_id = countyfp, tooltip = paste(county, "\nDate: ", date, "\nTotal cumulative cases: ", comma(cases, accuracy = 1), "\nCases per 100,000: ", comma(cases.per.100000, accuracy = 1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu")) +
  labs(title = paste("Total cumulative cases per 100,000 by ", max(cum.cases.county.map$date))) +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = cum.cases.county.map.plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```


<br>

# Deaths{.tabset}

The charts below provide the cumulative deaths where COVID-19 is a contributing factor per 100,000. 

The deaths per 100,000 by RUCA show a very different story compared to the cases per 100,000. Using these metrics, the more rural a county is the higher the death per 100,000. The entirely rural county group had the highest deaths per 100,000 with 275, followed closed by our town/rural county group which was 262 deaths per 100,000.

When broken down by region, the highest deaths per 100,000 was in Northwest MN with 253 followed by Central with 250 and Southwest at 231.

Even more interesting is by EDR. This very much shows that the more rural a region is, the higher the deaths per 100,000. For example in the Southwest planning region, EDR 6W had the highest deaths per 100,000 with a whopping 323 deaths per 100,000 compared to the more "metro" EDR 9 - South Central which had a 195 deaths per 100,000.

One other thing to point out is that the state map showing the total deaths per 100,000 for each county is very different than the cases per 100,000 map. For example, the counties surrounding Waseca and Mower had very high cumulative cases but that did not equal a high death rate for those counties. Same with Nobles, Roseau and Kandiyohi. This means that a lot of the folks that got sick in those counties were likely due to the spread within relatively healthy, younger folks.

<br>

```{r prep covid deaths, include=FALSE, cache=TRUE}
deaths.ruca <- master.deaths %>%
  group_by(Dem_Desc, date) %>%
  summarize(pop = sum(pop, na.rm = TRUE),
            deaths = sum(deaths, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(deaths.per.100000 = (deaths / pop) * 100000,
         data_id = seq(n()))

deaths.pr <- master.deaths %>%
  group_by(planning.region, date) %>%
  summarize(pop = sum(pop, na.rm = TRUE),
            deaths = sum(deaths, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(deaths.per.100000 = (deaths / pop) * 100000,
         data_id = seq(n()))

deaths.edr <- master.deaths %>%
  group_by(edr, planning.region, date) %>%
  summarize(pop = sum(pop, na.rm = TRUE),
            deaths = sum(deaths, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(deaths.per.100000 = (deaths / pop) * 100000,
         data_id = seq(n()))

deaths.county.map <- master.deaths %>%
  mutate(deaths.per.100000 = (deaths / pop) * 100000) %>%
  filter(date == max(date)) %>%
  mutate(deaths.per.100000.bins = cut(deaths.per.100000,
                                      breaks = c(0, 200, 250, 300, 350, 1000),
                                      labels = c("Less than 200 per 100,000", "200 to 250 per 100,000", "250 to 300 per 100,000", "300 to 350 per 100,000", "More than 350 per 100,000"))) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")

```

## RUCA

<br>

```{r chart deaths per 100000 ruca}
deaths.ruca.plot <- ggplot(deaths.ruca, aes(date, deaths.per.100000, color = Dem_Desc)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nDate: ", date, "\nCumulative deaths: ", comma(deaths, accuracy = 1), "\nCumulative deaths per 100,000: ", comma(deaths.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative deaths per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(deaths.ruca, date == max(date)), aes(label = comma(deaths.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = deaths.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## Planning Regions

<br>

```{r chart deaths per 100000 pr}
deaths.pr.plot <- ggplot(deaths.pr, aes(date, deaths.per.100000, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(planning.region, "\nDate: ", date, "\nCumulative deaths: ", comma(deaths, accuracy = 1), "\nCumulative deaths per 100,000: ", comma(deaths.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative deaths per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(deaths.pr, date == max(date)), aes(label = comma(deaths.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = deaths.pr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart deaths per 100000 edr}
deaths.edr.plot <- ggplot(deaths.edr, aes(date, deaths.per.100000, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(edr, "\nDate: ", date, "\nCumulative deaths: ", comma(deaths, accuracy = 1), "\nCumulative deaths per 100,000: ", comma(deaths.per.100000, accuracy = 1), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Cumulative deaths per 100,000", caption = "MN Dept. of Health")+
  geom_label_repel(data = filter(deaths.edr, date == max(date)), aes(label = comma(deaths.per.100000, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = deaths.edr.plot, width_svg = 10, height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))

```

<br>

## County map

<br>

```{r map deaths per 100,000 county}
deaths.county.map.plot <- ggplot(deaths.county.map) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = deaths.per.100000.bins, data_id = countyfp, tooltip = paste(county, "\nDate: ", date, "\nTotal deaths: ", comma(deaths, accuracy = 1), "\nDeaths per 100,000: ", comma(deaths.per.100000, accuracy = 1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu")) +
  labs(title = paste("Total deaths per 100,000 by ", max(deaths.county.map$date))) +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = deaths.county.map.plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

# Vaccinations{.tabset}

Below is a map and charts with the percentage of the population 5 or older that has had at least one vaccination dose.

Vaccinations lag behind significantly in more rural areas, not surprisingly considering the case and death rates. The lowest vaccination percentage is in our town/rural mix counties with 61% followed by entirely rural and urban/town/rural mix county group with 64% each. Our entirely urban county group is near 80% of their population 5 and older with at least one vaccine dose.

When broken down by region, the lowest vaccination are a combination of rural and larger towns in Greater Minnesota. The lowest rate is actually in Central Minnesota with 58%. EDR 7E - East Central had the lowest in that planning region with 54.4%.

The next lowest percentage was Northwest Minnesota 60%. The EDR with the lowest was EDR 5 - North Central at 56.7%.

Interestingly, Southwest and Northeast Minnesota which contain some of our most rural counties in the state had relatively high rates. Northeast had nearly 71% of their population age 5+ vaccinated with at least one dose. Southwest had nearly 65% of their population vaccinated with one dose with EDR 9 - South Central leading the way with 65.5%.

The county map shows that the lowest vaccination rates are actually occurring relatively close the seven county metro. Counties North of that region had the lowest percentages in the state. But, counties along the western border also had relatively low percentages as well. 
  

<br>

```{r prep vaccine one dose, include=FALSE, cache=TRUE}
vaccine.county.map <- master.vaccinations %>%
  mutate(one.dose.pct = `People with at least one vaccine dose` / age.5plu,
         complete.dose.pct = `People with completed vaccine series` / age.5plu,
         one.dose.pct.bins = cut(one.dose.pct,
                                 breaks = c(0, .55, .6, .65, .7, 1),
                                 labels = c("Between 40% and 55%", "55% to 60%", "60% to 65%", "65% to 70%", "More than 70% vaccinated")),
         complete.dose.pct.bins = cut(complete.dose.pct,
                                      breaks = c(0, .55, .6, .65, .7, 1),
                                      labels = c("Between 40% and 55%", "55% to 60%", "60% to 65%", "65% to 70%", "More than 70% vaccinated"))) %>%
  gather(key = "dose", value = "pct", 15, 16) %>%
  mutate(dose = ifelse(dose == "one.dose.pct.bins", "At least one dose", "Fully vaccinated"),
         pct = as.factor(pct),
         pct = fct_relevel(pct, "Between 40% and 55%", "55% to 60%", "60% to 65%", "65% to 70%", "More than 70% vaccinated")) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")


vaccine.ruca <- master.vaccinations %>%
  group_by(Dem_Desc) %>%
  summarise(one.dose = sum(`People with at least one vaccine dose`, na.rm = TRUE),
            complete.dose = sum(`People with completed vaccine series`, na.rm = TRUE),
            pop = sum(age.5plu)) %>%
  ungroup() %>%
  mutate(one.dose.pct = one.dose / pop,
         complete.dose.pct = complete.dose / pop) %>%
  gather(key = "dose", value = "pct", 5,6) %>%
  mutate(dose = ifelse(dose == "one.dose.pct", "At least one dose", "Full vaccinated")) %>%
  mutate(data_id = seq(n()))

vaccine.pr <- master.vaccinations %>%
  group_by(planning.region) %>%
  summarise(one.dose = sum(`People with at least one vaccine dose`, na.rm = TRUE),
            complete.dose = sum(`People with completed vaccine series`, na.rm = TRUE),
            pop = sum(age.5plu)) %>%
  ungroup() %>%
  mutate(one.dose.pct = one.dose / pop,
         complete.dose.pct = complete.dose / pop) %>%
  gather(key = "dose", value = "pct", 5,6) %>%
  mutate(dose = ifelse(dose == "one.dose.pct", "At least one dose", "Fully vaccinated"),
         data_id = seq(n()))

vaccine.edr <- master.vaccinations %>%
  group_by(edr, planning.region) %>%
  summarise(one.dose = sum(`People with at least one vaccine dose`, na.rm = TRUE),
            complete.dose = sum(`People with completed vaccine series`, na.rm = TRUE),
            pop = sum(age.5plu)) %>%
  ungroup() %>%
  mutate(one.dose.pct = one.dose / pop,
         complete.dose.pct = complete.dose / pop) %>%
  gather(key = "dose", value = "pct", 6,7) %>%
  mutate(dose = ifelse(dose == "one.dose.pct", "At least one dose", "Fully vaccinated"),
         data_id = seq(n()))

```

## RUCA

<br>

```{r chart one dose pct ruca}
vaccine.ruca.plot <- ggplot(vaccine.ruca, aes(Dem_Desc, pct, fill = dose, group = dose)) +
    geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = ifelse(dose == "At least one dose", paste(Dem_Desc, "\nNumber of people with at least on dose: ", comma(one.dose, accuracy = 1), "\nPercent of population 5+ with at least one dose: ", percent(pct, accuracy = .1), sep = ""), paste(Dem_Desc, "\nNumber of people fully vaccinated: ", comma(complete.dose, accuracy = 1), "\nPercent of population 5+ fully vaccinated: ", percent(pct, accuracy = .1), sep = "")))) +
    geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
    labs(x="", y = "", color="", title = "Percent of population age 5+ vaccine status", caption = "MN Dept. of Health")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
    theme_bar+
    scale_fill_manual(values = brewer.pal(n = 2, "PuBu"),
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 18))


girafe(ggobj = vaccine.ruca.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

<br>

```{r chart one dose pct pr}
vaccine.pr.plot <- ggplot(vaccine.pr, aes(planning.region, pct, fill = dose, group = dose)) +
    geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = ifelse(dose == "At least one dose", paste(planning.region, "\nNumber of people with at least on dose: ", comma(one.dose, accuracy = 1), "\nPercent of population 5+ with at least one dose: ", percent(pct, accuracy = .1), sep = ""), paste(planning.region, "\nNumber of people fully vaccinated: ", comma(complete.dose, accuracy = 1), "\nPercent of population 5+ fully vaccinated: ", percent(pct, accuracy = .1), sep = "")))) +
    geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
    labs(x="", y = "", color="", title = "Percent of population age 5+ vaccine status", caption = "MN Dept. of Health")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
    theme_bar+
    scale_fill_manual(values = brewer.pal(n = 2, "PuBu"),
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 18))


girafe(ggobj = vaccine.pr.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

## EDR

<br>

```{r chart one dose pct edr}
vaccine.edr.plot <- ggplot(vaccine.edr, aes(edr, pct, fill = dose, group = dose)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free_x") +
    geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = ifelse(dose == "At least one dose", paste(edr, "\nNumber of people with at least on dose: ", comma(one.dose, accuracy = 1), "\nPercent of population 5+ with at least one dose: ", percent(pct, accuracy = .1), sep = ""), paste(edr, "\nNumber of people fully vaccinated: ", comma(complete.dose, accuracy = 1), "\nPercent of population 5+ fully vaccinated: ", percent(pct, accuracy = .1), sep = "")))) +
    geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
    labs(x="", y = "", color="", title = "Percent of population age 5+ vaccine status", caption = "MN Dept. of Health")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
    theme_bar+
    scale_fill_manual(values = brewer.pal(n = 2, "PuBu"),
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 18))


girafe(ggobj = vaccine.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))
```

<br>

## County map

<br> 

```{r map one dose pct county}
vaccine.county.map.plot <- ggplot(vaccine.county.map) +
  facet_wrap(~dose, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct, data_id = County, tooltip = ifelse(dose == "At least one dose", paste(County, "\nVaccine status as of ", reportedDate, "\nNumber of people with at least one dose: ", comma(`People with at least one vaccine dose`, accuracy = 1), "\nPercent of population age 5+ with at least one dose: ", percent(one.dose.pct, accuracy = .1), sep = ""), paste(County, "\nNumber of people fully vaccinated: ", comma(`People with completed vaccine series`, accuracy = 1), "\nPercent of population age 5+ fully vaccinated: ", percent(complete.dose.pct, accuracy = .1), sep = "")))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu")) +
  labs(title = paste("Percent of population age 5+ with at least one vaccine dose as of ", vaccine.county.map$reportedDate, sep = ""), caption = "MN Department of Health") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = vaccine.county.map.plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```


<br>

# {.unnumbered .unlisted .toc-ignore}

The chart below provides the percent of the population vaccinated by race and ethnicity as of the beginning of February 2022. There is a pretty wide discrepancy in vaccination rates across race and ethnicity. The highest percentages is people of Asian and Pacific Islander race with 86.2% getting at least one dose. This is followed by white and Hispanic with 70.5% of the population with eat least one does. I'm not entirely certain why multiracial is so low. 

Unfortunately, vaccination among American Indians is also quite low with only 60.3% vaccinated.

<br>

```{r prep vaccination by race and ethnicity, include=FALSE, cache=TRUE}
vaccinations.race <- master.vaccinations.race %>%
  filter(year == max(year)) %>%
  filter(week == max(week)) %>%
  select(1:10) %>%
  gather(key = "race.ethnicity", value = "pct.vaccinated", 5:10) %>%
  group_by(case_definition) %>%
  arrange(desc(pct.vaccinated)) %>%
  ungroup() %>%
  filter(`Age group` == "5+") %>%
  mutate(data_id = as.character(seq(n())),
         pct.vaccinated = str_sub(pct.vaccinated, 1, 5),
         pct.vaccinated = as.numeric(pct.vaccinated),
         pct.vaccinated = pct.vaccinated / 100,
         race.ethnicity = fct_relevel(race.ethnicity, "Asian/Pacific Islander", "White", "Hispanic", "Black/African American", "American Indian", "Multiracial"))
```

```{r chart pct vaccinated by race and ethnicity}
vaccinations.race.plot <- ggplot(vaccinations.race, aes(race.ethnicity, pct.vaccinated, fill = case_definition, group = case_definition)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(race.ethnicity, "\nYear: ", year, "\nWeek of year: ", week, "\nVaccination dose: ", case_definition, "\nPercent vaccinated: ", percent(pct.vaccinated, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(pct.vaccinated, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
    labs(x="", y = "", color="", title = paste("Percent vaccinated as of week ", max(vaccinations.race$week), " of year ", max(vaccinations.race$year), sep = ""), caption = "\nMN Department of Health")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
    theme_bar+
    scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 18))


girafe(ggobj = vaccinations.race.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))


```
